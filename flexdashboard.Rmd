---
title: "Nécessité de détailler l'IDH"
author: "Laurine KOMENDANCZYK & Yannis BARBA"
output: 
  flexdashboard::flex_dashboard:
    theme: bootstrap
    orientation: columns
    vertical_layout: fill
    navbar:
      - { title: "Moodle", href: "https://tice.agrocampus-ouest.fr/course/view.php?id=6726", align: left }
      - { icon: "fa-twitter", href: "https://twitter.com/marie_etienne", align: right }
      - { icon: "fa-linkedin", href: "https://www.linkedin.com/in/marie-etienne-818a7115/", align: right }
params:
  setup_path: ../resources/
---

<style>                     
.navbar {
  background-color:#46ACC8;
  border-color:#46ACC8;
}
.navbar-brand {
color:black!important;
}


</style>   


```{r setup, include=FALSE}
library('flexdashboard')
library('plotly')
library('tidyverse')
library('ggplot2')
library("ggthemes")
library("gridExtra")
library("sf")
library("rnaturalearth")
library("rnaturalearthdata")
library("ggnewscale")
```

Column {data-width=650}
-----------------------------------------------------------------------

### An easy solution for dashboard

```{r, echo = TRUE}
#install.package('flexdasboard')
#rmarkdown::draft("dashboard.Rmd", template = "flex_dashboard", package = "flexdashboard")
```

The [flexdashboard website](https://rmarkdown.rstudio.com/flexdashboard/index.html) provides multiple advanced examples.

```{r}
data <- read.csv("./dataset/HDI.csv", sep=",", header = TRUE)
world <- ne_countries(scale = "medium", returnclass = "sf")

## Data pre-processing : rename of certain value
data[data$Country == "Congo (Democratic Republic of the)", "Country"] <- "Democratic Republic of the Congo"
data[data$Country == "Congo", "Country"] <- "Republic of Congo"
data[data$Country == "Tanzania (United Republic of)", "Country"] <- "Tanzania"
data[data$Country == "Bolivia (Plurinational State of)", "Country"] <- "Bolivia"
data[data$Country == "Korea (Republic of)", "Country"] <- "Republic of Korea" 

complete_data <- world %>% rename(Country = name_long) %>% inner_join(data, by="Country")

## Focus on africa

africa_data <- complete_data %>% filter(continent == "Africa")

## extract centroid 
sf_use_s2(FALSE)
countries_centroid <- st_centroid(africa_data$geometry)

africa_data <- cbind(africa_data, centroid = st_centroid(africa_data$geometry)) 

# computation of the indexes composing hdi
dta.hdi <- data.frame(africa_data[,c("Life.expectancy", 
                                     "Mean.years.of.schooling",
                                     "Gross.national.income..GNI..per.capita", 
                                     "Inequality.adjusted.life.expectancy.index", 
                                     "Inequality.adjusted.education.index",
                                     "Inequality.adjusted.income.index")])[,-7]

dta.hdi <- data.frame(c(dta.hdi, 
                        IESP = (dta.hdi[1] - 25)/(85 - 25),
                        INI = dta.hdi[2]/15, 
                        IPIB = (log(dta.hdi[3])-log(100)) /(log(40000) -log(100))))

rownames(dta.hdi) <- africa_data$sovereignt

```
```{r}
## Utils

mainTitle <- function(title, bgcolor){
  return(ggplot() +                      # Draw ggplot2 plot with text only
           annotate("text",
                    x = 1,
                    y = 0,
                    size = 7,
                    fontface=2,
                    label = title) + 
           theme_void()+
           theme(plot.background = element_rect(fill=bgcolor, color=bgcolor))
  )
}
```



```{r}
# create HDI class for a better representation
africa_data <- africa_data %>% drop_na(HDI)
HDISummary <- summary(africa_data$HDI)

HDIClass <- apply(africa_data, MARGIN = 1, FUN= function(x){
  
  if(as.numeric(x["HDI"]) <= HDISummary["1st Qu."]){
    return("TB")
  }
  if((as.numeric(x["HDI"]) > HDISummary["1st Qu."]) && (as.numeric(x["HDI"]) <=HDISummary["Median"])){
    return("B")
  }
  if((as.numeric(x["HDI"]) > HDISummary["Median"]) && (as.numeric(x["HDI"]) <=HDISummary["3rd Qu."])){
    return("M")
  }
  if(as.numeric(x["HDI"]) > HDISummary["3rd Qu."]){
    return("E")
  }
})

africa_data$HDIClass <- HDIClass
```


### First Graph

```{r}
#Calcul des limits de gradient

limitsHDI <- summary(africa_data$HDI)[c("Min.", "Max.")]
limitsIHDI <- summary(africa_data$Inequality.adjusted.HDI..IHDI.)[c("Min.", "Max.")]

limits <- c(min = min(limitsHDI["Min."], limitsIHDI["Min."]), max= max(limitsHDI["Max."], limitsIHDI["Max."]))

# Map of HDI in Africa
map_HDI <- africa_data %>%  ggplot() + 
  geom_sf(aes(fill=HDI)) +
  scale_fill_gradientn("IDH", 
                       colors=c("black", "#E64814", "#E9CB0D", "#9CDE3B"), 
                       limits = limits) +
  theme_tufte() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        plot.caption = element_text(hjust=0.5, vjust = 1, size=rel(1.2)))

#map_HDI


## second part of the first grahp : component of HDI

# Prenons deux pays avec un faible HDI et deux pays avec un fort HDI

#Faible
niger <- dta.hdi["Niger",]
car <- dta.hdi["Central African Republic",]

#Fort
southAfrica <- dta.hdi["South Africa",]
morocco <- dta.hdi["Morocco",]

hist.Niger <- data.frame(t(niger)[7:9,])
hist.CAR <- data.frame(t(car)[7:9,])

hist.RSA <- data.frame(t(southAfrica)[7:9,])
hist.Morocco <- data.frame(t(morocco)[7:9,])

colnames(hist.Niger) = c("value")
colnames(hist.CAR) = c("value")

colnames(hist.RSA) = c("value")
colnames(hist.Morocco) = c("value")


histoHDI <- data.frame(index = c("IESP", "INI", "IPIB","IESP", "INI", "IPIB"), 
                       rbind(hist.Niger, hist.RSA, hist.CAR, hist.Morocco))

histoHDI <- data.frame(histoHDI,
                       Country = c(rep("Niger",3), rep("South Africa", 3), rep("Central African Republic", 3), rep("Morocco", 3)))

indexes = rownames(histoHDI)
                       
colnames(histoHDI) <- c("index", "values", "Country")

# annotate with value of HDI
annotation <- data.frame(
   label=c("HDI: 0.35", "HDI: 0.67", "HDI: 0.35", "HDI: 0.65"),
   Country=c("Niger", "South Africa", "Central African Republic", "Morocco"),
   hjust=c(0, -0.2, 0, 0.2)
)

histo <- histoHDI %>% ggplot() +
  geom_col(aes(y = values, x=index, fill = index), width = 0.5) +
  facet_wrap(~Country)+
  
  geom_text(data = annotation,
            mapping = aes(x = 2, y=0.8, label=label),
            size=4,
            )+

  theme_tufte() +
  theme(legend.position = "None",
        axis.title = element_blank())

#histo

# Grid Extra for first visualisation

grid.arrange(
  grobs=list(map_HDI, histo),
  widths=c(1,1),
  #layout_matrix = rbind(c(1,1))
  bottom="Indice de développement humain en Afrique \n la valeur de l'IDH seule est insuffisante pour caractériser un pays"
)

```

Column {.tabset .tabset-fade}
-----------------------------------------------------------------------


### Second Graph

```{r}
# Plot first Map, Africa HDI and School
map_IHDI <- africa_data %>%  ggplot() + 
  #labs(title="Les limites de l'IDH",
   #       subtitle = "Absence de prise en compte des inégalités") +
  
  geom_sf(aes(fill=Inequality.adjusted.HDI..IHDI.)) +
  scale_fill_gradientn("IDH", colors=c("black", "#E64814", "#E9CB0D", "#9CDE3B")) +

  #geom_sf(aes(geometry = geometry.1, color=HDIClass , size=Inequality.in.income....)) +

  #scale_color_manual("Classes IDH", values=c("black", "#E64814", "#E9CB0D", "#9CDE3B"), 
   #                  breaks=c("TB", "B", "M", "E"), labels=c("Très Bas", "Bas", "Moyen",     "Élevé")) +

  scale_size(name="IHDI") +
  theme_tufte() +
  theme(axis.line = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank())
  #guides(fill = guide_colourbar(order=1),
         # color = guide_legend(order=2),
         # size = guide_legend(order=3))

map_IHDI

africa_data$RatioIDHI_IDH <- africa_data$Inequality.adjusted.HDI..IHDI. / africa_data$HDI

country <- africa_data$Country
highlightCountries <- rep(0, length(country))

highlightCountries[which(country=="South Africa")] <- data.frame(africa_data[which(country=="South Africa"),"RatioIDHI_IDH"])[-2][1,1]

highlightCountries[which(country=="Niger")] <- data.frame(africa_data[which(country=="Niger"),"RatioIDHI_IDH"])[-2][1,1]

ratio_graph <- africa_data %>% drop_na(Inequality.adjusted.HDI..IHDI.) %>% 
  
  ggplot() +
  
  # annotate("rect",
  #          xmin = Inf, xmax = 0, ymin = Inf, ymax = 0,
  #          fill=rgb(255, 204, 200,maxColorValue=255)) +
  geom_col(aes(y=reorder(Country, RatioIDHI_IDH), x=RatioIDHI_IDH, fill=HDIClass), width = 0.95) +
  scale_fill_manual("Classes IDH", values=c("#9CDE3B","#E9CB0D", "#E64814","black"),
                     breaks=c("E", "M", "B","TB"), labels=c("Élevé", "Moyen", "Bas","Très Bas"))+

  
  #geom_point(aes(x = reorder(Country, HDI), y=HDI, fill=HDIClass), width = 0.95) +
  
  # geom_col(data = data.frame(IHDI = africa_data$Inequality.adjusted.HDI..IHDI.,
  #                            Country=africa_data$Country, HDI=africa_data$HDI),
  #          aes(x=reorder(Country, HDI), y=IHDI), fill="darkred", width = 1) +
  
  labs(x="IHDI/HDI", y =element_blank()) +
  
  theme_light()+
  theme(axis.text.x = element_text(hjust=1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_line(color = "grey",
                                  size = 0.2,
                                  linetype = 1),
        panel.border = element_blank()
        ) +
  scale_x_continuous(breaks = seq(0,1, 0.1), limits = c(0,1))

ratio_graph
```



### Third Graph

```{r}

```

